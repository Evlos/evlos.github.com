<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content="Oracle Cloud is experiencing a network layer issue caused by VxLAN
Uninstallation k3s-uninstall.sh k3s-agent-uninstall.sh sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X && sudo iptables -L Installation curl -sfL https://get.k3s.io | sh - k3s kubectl get node sudo cat /var/lib/rancher/k3s/server/node-token sudo cat /etc/rancher/k3s/k3s.yaml vim ~/.kube/config # insecure-skip-tls-verify: true curl -sfL https://get.k3s.io | K3S_URL=https://10.0.0.134:6443 K3S_TOKEN=mynodetoken sh - sudo kubectl get node -w sudo kubectl apply -f config/eternalelf_tls_cert."><meta property="og:title" content="K3s & Kilo"><meta property="og:description" content="Oracle Cloud is experiencing a network layer issue caused by VxLAN
Uninstallation k3s-uninstall.sh k3s-agent-uninstall.sh sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X && sudo iptables -L Installation curl -sfL https://get.k3s.io | sh - k3s kubectl get node sudo cat /var/lib/rancher/k3s/server/node-token sudo cat /etc/rancher/k3s/k3s.yaml vim ~/.kube/config # insecure-skip-tls-verify: true curl -sfL https://get.k3s.io | K3S_URL=https://10.0.0.134:6443 K3S_TOKEN=mynodetoken sh - sudo kubectl get node -w sudo kubectl apply -f config/eternalelf_tls_cert."><meta property="og:type" content="article"><meta property="og:url" content="/posts/k3s-and-kilo/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-18T12:33:09+08:00"><meta property="article:modified_time" content="2022-11-18T12:33:09+08:00"><title>K3s & Kilo</title><link rel=canonical href=/posts/k3s-and-kilo/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-66839894-6"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-66839894-6")</script><style type=text/css>pre{width:100%;overflow:hidden}img{max-width:90%}h2{color:#b3befe}a{color:#aaa;text-decoration:none}a:hover{text-decoration:underline}li.post-item{color:#6b6f84}li.post-item .meta{font-size:85%;padding-right:2px}li.post-item a{font-family:monospace;font-size:110%;color:#b3befe}body{background-color:#333;color:#eee}pre{background-color:#272822}code{max-width:98%;text-wrap-mode:wrap}footer{color:#555}header h1{text-transform:uppercase;font-family:monospace;background:#3facfe;color:rgba(255,255,255,.8);display:inline-block;margin:2px;padding:0 8px}</style></head><body lang><section class="main post"><div class=container><div class=content><div class=front-matter><div class=title-container><h2>K3s & Kilo</h2></div><div class=meta><div class=date title='Fri Nov 18 2022 12:33:09 +0800'>Nov 18, 2022</div><div class=reading-time><div class=middot></div></div></div></div><div class=markdown><p><strong>Oracle Cloud is experiencing a network layer issue caused by VxLAN</strong></p><h2 id=uninstallation>Uninstallation</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>k3s-uninstall.sh
</span></span><span style=display:flex><span>k3s-agent-uninstall.sh
</span></span><span style=display:flex><span>sudo iptables -F <span style=color:#f92672>&amp;&amp;</span> sudo iptables -t nat -F <span style=color:#f92672>&amp;&amp;</span> sudo iptables -t mangle -F <span style=color:#f92672>&amp;&amp;</span> sudo iptables -X <span style=color:#f92672>&amp;&amp;</span> sudo iptables -L
</span></span></code></pre></div><h2 id=installation>Installation</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -sfL https://get.k3s.io | sh -
</span></span><span style=display:flex><span>k3s kubectl get node
</span></span><span style=display:flex><span>sudo cat /var/lib/rancher/k3s/server/node-token
</span></span><span style=display:flex><span>sudo cat /etc/rancher/k3s/k3s.yaml
</span></span><span style=display:flex><span>vim ~/.kube/config
</span></span><span style=display:flex><span><span style=color:#75715e># insecure-skip-tls-verify: true</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -sfL https://get.k3s.io | K3S_URL<span style=color:#f92672>=</span>https://10.0.0.134:6443 K3S_TOKEN<span style=color:#f92672>=</span>mynodetoken sh -
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo kubectl get node -w
</span></span><span style=display:flex><span>sudo kubectl apply -f config/eternalelf_tls_cert.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># skip</span>
</span></span><span style=display:flex><span>cat cloudflare.pem | base64 -w <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>cat cloudflare.key | base64 -w <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>rsync -avzP data_registry/ ubuntu@10.0.0.130:data_registry
</span></span></code></pre></div><h2 id=kilo>Kilo</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;--tls-san EXTERNAL_IP --node-external-ip EXTERNAL_IP&#34;</span> sh -
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo cat /var/lib/rancher/k3s/server/node-token
</span></span><span style=display:flex><span>sudo cat /etc/rancher/k3s/k3s.yaml
</span></span><span style=display:flex><span>insecure-skip-tls-verify: true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kko annotate nodes HOSTNAME_A kilo.squat.ai/force-endpoint<span style=color:#f92672>=</span>EXTERNAL_IP:51821
</span></span><span style=display:flex><span>kko annotate nodes HOSTNAME_B kilo.squat.ai/force-endpoint<span style=color:#f92672>=</span>EXTERNAL_IP:51821
</span></span><span style=display:flex><span>kko annotate nodes HOSTNAME_C kilo.squat.ai/force-endpoint<span style=color:#f92672>=</span>EXTERNAL_IP:51821
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kko annotate nodes HOSTNAME_A kilo.squat.ai/location<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jp&#34;</span>
</span></span><span style=display:flex><span>kko annotate nodes HOSTNAME_B kilo.squat.ai/location<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jp&#34;</span>
</span></span><span style=display:flex><span>kko annotate nodes HOSTNAME_C kilo.squat.ai/location<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jp&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ExecStart<span style=color:#f92672>=</span>/usr/local/bin/k3s <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    server <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;--tls-san&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;EXTERNAL_IP&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;--node-externaluninstall-ip&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>        <span style=color:#e6db74>&#39;EXTERNAL_IP&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl daemon-reload
</span></span><span style=display:flex><span>sudo systemctl restart k3s.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kko apply -f https://raw.githubusercontent.com/squat/kilo/main/manifests/crds.yaml
</span></span><span style=display:flex><span>kko apply -f kilo-k3s.yaml
</span></span></code></pre></div><br><p class=back-to-posts><a href=/>[back]</a></p></div><br></div></div></section>