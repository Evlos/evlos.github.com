<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content="And not automatically rotated.
Issue Kubectl is not able to connect to the k3s server after months:
kubectl get node error: You must be logged in to the server (Unauthorized) Telegram bot cannot connect to api.telegram.org:
telegram.error.NetworkError: urllib3 HTTPError HTTPSConnectionPool(host='api.telegram.org', port=443): Max retries exceeded with url Verify the problem sudo kubectl get node # execute on the k3s server node error: You must be logged in to the server (Unauthorized) openssl s_client -connect localhost:6443 -showcerts < /dev/null 2>&amp;1 | openssl x509 -noout -enddate # check the expiration date of the certificate Certificate has expired Force k3s to rotate the certificate:"><meta property="og:title" content="K3s Certificate Expiration"><meta property="og:description" content="And not automatically rotated.
Issue Kubectl is not able to connect to the k3s server after months:
kubectl get node error: You must be logged in to the server (Unauthorized) Telegram bot cannot connect to api.telegram.org:
telegram.error.NetworkError: urllib3 HTTPError HTTPSConnectionPool(host='api.telegram.org', port=443): Max retries exceeded with url Verify the problem sudo kubectl get node # execute on the k3s server node error: You must be logged in to the server (Unauthorized) openssl s_client -connect localhost:6443 -showcerts < /dev/null 2>&amp;1 | openssl x509 -noout -enddate # check the expiration date of the certificate Certificate has expired Force k3s to rotate the certificate:"><meta property="og:type" content="article"><meta property="og:url" content="/posts/k3s-certificate-expiration/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-20T14:49:10+08:00"><meta property="article:modified_time" content="2023-11-20T14:49:10+08:00"><title>K3s Certificate Expiration</title><link rel=canonical href=/posts/k3s-certificate-expiration/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-66839894-6"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-66839894-6")</script><style type=text/css>pre{width:100%;overflow:hidden}img{max-width:90%}a{color:#aaa;text-decoration:none}a:hover{text-decoration:underline}li.post-item .meta{font-size:90%}li.post-item{color:#777}body{background-color:#333;color:#eee}pre{background-color:#272822}code{max-width:98%;text-wrap-mode:wrap}footer{color:#555}header h1{text-transform:uppercase;font-family:monospace}</style></head><body lang><section class="main post"><div class=container><div class=content><div class=front-matter><div class=title-container><h2>K3s Certificate Expiration</h2></div><div class=meta><div class=date title='Mon Nov 20 2023 14:49:10 +0800'>Nov 20, 2023</div><div class=reading-time><div class=middot></div></div></div></div><div class=markdown><p>And not automatically rotated.</p><h2 id=issue>Issue</h2><p>Kubectl is not able to connect to the k3s server after months:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get node
</span></span><span style=display:flex><span>error: You must be logged in to the server <span style=color:#f92672>(</span>Unauthorized<span style=color:#f92672>)</span>
</span></span></code></pre></div><p>Telegram bot cannot connect to <strong>api.telegram.org</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>telegram.error.NetworkError: urllib3 HTTPError HTTPSConnectionPool<span style=color:#f92672>(</span>host<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;api.telegram.org&#39;</span>, port<span style=color:#f92672>=</span>443<span style=color:#f92672>)</span>: Max retries exceeded with url
</span></span></code></pre></div><h2 id=verify-the-problem>Verify the problem</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo kubectl get node
</span></span><span style=display:flex><span><span style=color:#75715e># execute on the k3s server node</span>
</span></span><span style=display:flex><span>error: You must be logged in to the server <span style=color:#f92672>(</span>Unauthorized<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>openssl s_client -connect localhost:6443 -showcerts &lt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span> | openssl x509 -noout -enddate
</span></span><span style=display:flex><span><span style=color:#75715e># check the expiration date of the certificate</span>
</span></span></code></pre></div><h2 id=certificate-has-expired>Certificate has expired</h2><p>Force k3s to rotate the certificate:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo rm /var/lib/rancher/k3s/server/tls/dynamic-cert.json
</span></span><span style=display:flex><span>sudo kubectl --insecure-skip-tls-verify<span style=color:#f92672>=</span>true delete secret -n kube-system k3s-serving
</span></span><span style=display:flex><span>sudo systemctl restart k3s
</span></span><span style=display:flex><span>sudo journalctl -fxu k3s
</span></span></code></pre></div><h2 id=fix-k3s-agent-error>Fix k3s-agent error</h2><p>Error message: <code>Error syncing pod, skipping</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /etc/rancher/k3s/k3s.yaml
</span></span><span style=display:flex><span><span style=color:#75715e># update the certificate data according to the server configuration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl restart k3s-agent
</span></span><span style=display:flex><span>sudo systemctl status k3s-agent
</span></span><span style=display:flex><span>sudo journalctl -fxu k3s-agent
</span></span></code></pre></div><p>Restart kilo if needed; this could also fix the issue that the pod cannot resolve DNS requests.</p><h2 id=k3s-upgrade-optional>K3S upgrade (Optional)</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/local/bin/k3s -v
</span></span><span style=display:flex><span>k3s version v1.25.3+k3s1 <span style=color:#f92672>(</span>f2585c16<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>go version go1.19.2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo wget https://github.com/k3s-io/k3s/releases/download/v1.28.3%2Bk3s2/k3s-arm64 -O /usr/local/bin/k3s
</span></span><span style=display:flex><span>sudo wget https://github.com/k3s-io/k3s/releases/download/v1.28.3%2Bk3s2/k3s -O /usr/local/bin/k3s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/usr/local/bin/k3s -v
</span></span><span style=display:flex><span>k3s version v1.28.3+k3s2 <span style=color:#f92672>(</span>bbafb86e<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>go version go1.20.10
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl restart k3s
</span></span><span style=display:flex><span>sudo systemctl restart k3s-agent
</span></span></code></pre></div><br><p class=back-to-posts><a href=/>[back]</a></p></div><br></div></div></section>