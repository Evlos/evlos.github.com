<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content="以下内容恢复自 Wordpress 时期的数据库备份，内容已经严重过期，仅留作纪念。
折腾就是一种乐趣。我需要充满创意的生活，所以总是无尽地折腾着。这篇文章的配图有点儿老了，因为我总是有点子就新建草稿，所以发布就迟了一些。
以下是如何给 Dabr 增加用户头像缓存功能，毕竟这个头像服务器也蛮脆弱的，有延迟。其实代码还是老代码，是给 WP 增加头像缓存的代码。
Dabr 用户头像缓存功能： 直接修改 Dabr 程序中的这个文件即可 - /common/twitter.php，首先我们找到下面这个函数。
function theme_avatar($url, $force_large = false) { $size = $force_large ? 48 : 24; return \&#34;<img src=\'$url\' height=\'$size\' width=\'$size\' />\&#34;; } 然后修改成下面这样子即可，程序会自动创建 /ava/ 文件夹来存放头像缓存文件。
function theme_avatar($url, $force_large = false) { $size = $force_large ? 48 : 24; $dir = \'./ava/\'; if (!is_dir($dir)) { mkdir($dir); } $time = 1209600; preg_match(\'/[^\\/]*$/i\',$url,$name); $local = $dir.$name[0]; if (!is_file($local)||(time()-filemtime($local))>$time){ copy($url,$local); } return \&#34;<img src=\'$local\' height=\'$size\' width=\'$size\' />\&#34;; } 生活手记： 最近荷兰的天气突然开始升温了，速度升的好快，大家都变成了穿短袖的样子，太阳也出来了。其实从初到荷兰到现在，还没有看见过多少次的太阳，最近天天看着反而不习惯了。"><meta property="og:title" content="如何为 Dabr 增加用户头像缓存功能"><meta property="og:description" content="以下内容恢复自 Wordpress 时期的数据库备份，内容已经严重过期，仅留作纪念。
折腾就是一种乐趣。我需要充满创意的生活，所以总是无尽地折腾着。这篇文章的配图有点儿老了，因为我总是有点子就新建草稿，所以发布就迟了一些。
以下是如何给 Dabr 增加用户头像缓存功能，毕竟这个头像服务器也蛮脆弱的，有延迟。其实代码还是老代码，是给 WP 增加头像缓存的代码。
Dabr 用户头像缓存功能： 直接修改 Dabr 程序中的这个文件即可 - /common/twitter.php，首先我们找到下面这个函数。
function theme_avatar($url, $force_large = false) { $size = $force_large ? 48 : 24; return \&#34;<img src=\'$url\' height=\'$size\' width=\'$size\' />\&#34;; } 然后修改成下面这样子即可，程序会自动创建 /ava/ 文件夹来存放头像缓存文件。
function theme_avatar($url, $force_large = false) { $size = $force_large ? 48 : 24; $dir = \'./ava/\'; if (!is_dir($dir)) { mkdir($dir); } $time = 1209600; preg_match(\'/[^\\/]*$/i\',$url,$name); $local = $dir.$name[0]; if (!is_file($local)||(time()-filemtime($local))>$time){ copy($url,$local); } return \&#34;<img src=\'$local\' height=\'$size\' width=\'$size\' />\&#34;; } 生活手记： 最近荷兰的天气突然开始升温了，速度升的好快，大家都变成了穿短袖的样子，太阳也出来了。其实从初到荷兰到现在，还没有看见过多少次的太阳，最近天天看着反而不习惯了。"><meta property="og:type" content="article"><meta property="og:url" content="/posts/1939_add-avatar-cache-to-dabr/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2010-04-29T03:05:57+08:00"><meta property="article:modified_time" content="2010-04-29T03:05:57+08:00"><title>如何为 Dabr 增加用户头像缓存功能</title><link rel=canonical href=/posts/1939_add-avatar-cache-to-dabr/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-66839894-6"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-66839894-6")</script><style type=text/css>pre{width:100%;overflow:hidden}img{max-width:90%}h2{color:#b3befe;text-transform:uppercase;font-family:fangsong,sans-serif}a{color:#aaa;text-decoration:none}a:hover{text-decoration:underline}li.post-item{color:#6b6f84}li.post-item .meta{font-size:85%;padding-right:2px}li.post-item a{font-family:monospace;font-size:110%;color:#b3befe}body{background-color:#333;color:#eee}pre{background-color:#272822}code{max-width:98%;text-wrap-mode:wrap}footer{color:#555}header h1{text-transform:uppercase;font-family:monospace;background:#3facfe;color:rgba(255,255,255,.8);display:inline-block;margin:2px;padding:0 8px}</style></head><body lang><section class="main post"><div class=container><div class=content><div class=front-matter><div class=title-container><h2>如何为 Dabr 增加用户头像缓存功能</h2></div><div class=meta><div class=date title='Thu Apr 29 2010 03:05:57 +0800'>Apr 29, 2010</div><div class=reading-time><div class=middot></div></div></div></div><div class=markdown><blockquote><p>以下内容恢复自 Wordpress 时期的数据库备份，内容已经严重过期，仅留作纪念。</p></blockquote><hr><p>折腾就是一种乐趣。我需要充满创意的生活，所以总是无尽地折腾着。这篇文章的配图有点儿老了，因为我总是有点子就新建草稿，所以发布就迟了一些。</p><p>以下是如何给 Dabr 增加用户头像缓存功能，毕竟这个头像服务器也蛮脆弱的，有延迟。其实代码还是老代码，是给 WP 增加头像缓存的代码。</p><h2 id=dabr-用户头像缓存功能>Dabr 用户头像缓存功能：</h2><p>直接修改 Dabr 程序中的这个文件即可 - /common/twitter.php，首先我们找到下面这个函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>theme_avatar</span>($url, $force_large <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>  $size <span style=color:#f92672>=</span> $force_large <span style=color:#f92672>?</span> <span style=color:#ae81ff>48</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>24</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;&lt;img src=\&#39;</span><span style=color:#e6db74>$url\</span><span style=color:#e6db74>&#39; height=\&#39;</span><span style=color:#e6db74>$size\</span><span style=color:#e6db74>&#39; width=\&#39;</span><span style=color:#e6db74>$size\</span><span style=color:#e6db74>&#39; /&gt;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span></code></pre></div><p>然后修改成下面这样子即可，程序会自动创建 /ava/ 文件夹来存放头像缓存文件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>theme_avatar</span>($url, $force_large <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>  $size <span style=color:#f92672>=</span> $force_large <span style=color:#f92672>?</span> <span style=color:#ae81ff>48</span> <span style=color:#f92672>:</span> <span style=color:#ae81ff>24</span>;
</span></span><span style=display:flex><span>  $dir <span style=color:#f92672>=</span> <span style=color:#a6e22e>\</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>./</span><span style=color:#a6e22e>ava</span><span style=color:#f92672>/</span><span style=color:#a6e22e>\</span><span style=color:#960050;background-color:#1e0010>&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_dir</span>($dir)) { <span style=color:#a6e22e>mkdir</span>($dir); }
</span></span><span style=display:flex><span>  $time <span style=color:#f92672>=</span> <span style=color:#ae81ff>1209600</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>preg_match</span>(<span style=color:#a6e22e>\</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>/</span>[<span style=color:#f92672>^</span><span style=color:#a6e22e>\\</span><span style=color:#f92672>/</span>]<span style=color:#f92672>*</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#f92672>/</span><span style=color:#a6e22e>i\</span><span style=color:#960050;background-color:#1e0010>&#39;</span>,$url,$name);
</span></span><span style=display:flex><span>  $local <span style=color:#f92672>=</span> $dir<span style=color:#f92672>.</span>$name[<span style=color:#ae81ff>0</span>];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>is_file</span>($local)<span style=color:#f92672>||</span>(<span style=color:#a6e22e>time</span>()<span style=color:#f92672>-</span><span style=color:#a6e22e>filemtime</span>($local))<span style=color:#f92672>&gt;</span>$time){
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>copy</span>($url,$local);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>\</span><span style=color:#e6db74>&#34;&lt;img src=\&#39;</span><span style=color:#e6db74>$local\</span><span style=color:#e6db74>&#39; height=\&#39;</span><span style=color:#e6db74>$size\</span><span style=color:#e6db74>&#39; width=\&#39;</span><span style=color:#e6db74>$size\</span><span style=color:#e6db74>&#39; /&gt;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}
</span></span></span></code></pre></div><h2 id=生活手记>生活手记：</h2><p>最近荷兰的天气突然开始升温了，速度升的好快，大家都变成了穿短袖的样子，太阳也出来了。其实从初到荷兰到现在，还没有看见过多少次的太阳，最近天天看着反而不习惯了。</p><p>&lt;img src='http://www.evlos.org/ev-box/myimg/uploads/IMAG0160.jpg' /></p><p>第一张照片是初到荷兰的样子，一直天气阴云密布的，不过我也很喜欢下雨天的。</p><p>&lt;img src='http://www.evlos.org/ev-box/myimg/uploads/IMAG0123.jpg' /></p><p>&lt;img src='http://www.evlos.org/ev-box/myimg/uploads/IMAG0122.jpg' /></p><p>上面两张则是最近几天在公园里面照的，这里公园的景色真不赖。</p><br><p class=back-to-posts><a href=/>[back]</a></p></div><br></div></div></section>